# 데이터베이스8

## QuerySet API

- gt (greater than)

`Entry.objects.filter(id__gt = 4)`

`SELECT ... WHERE id > 4;`

- gte (greater than equal)

`Entry.objects.filter(id__gte = 4)`

`SELECT ... WHERE id >= 4`;

- lt (less than), lte (less than equal)
- in

```python
Entry.objects.filter(id__in = [1, 3, 4])
Entry.objects.filter(headline__in = 'abc')
```

```sqlite
SELECT ... WHERE id IN (1, 3, 4);
SELECT ... WHERE headline IN ('a', 'b', 'c');
```

- startswith

`Entry.objects.filter(headline__startswith = 'Lennon')`

`SELECT ... WHERE headline LIKE 'Lennon%'`;

- istartswith - 대소문자 구분 안함

`Entry.objects.filter(headline__istartswith = 'Lennon')`

`SELECT ... WHERE headline ILIKE 'Lennon%';`

- contains, icontains

```python
Entry.objects.filter(headline__contains = 'Lennon')
Entry.objects.filter(headline__icontains = 'Lennon')
```

```sqlite
SELECT ... WHERE headline LIKE '%Lennon%';
SELECT ... WHERE headline ILIKE '%Lennon%'
```

- range

```python
import datetime
start_date = datetime.date(2005, 1, 1)
end_date = datetime.date(2005, 12, 31)
Entry.objects.filter(pub_date__range = (start_date, end_date))
```

```sqlite
SELECT ... WHERE pub_date BETWEEN '2005-01-01' AND '2005-12-31';
```

- 복합 활용

```python
inner_qs = Blog.objects.filter(name_contains = 'Cheddar')
entries = Entry.objects.filter(blog__in = inner_qs)
```

```sqlite
SELECT ... WHERE blog.id IN (SELECT id FROM ... WHERE NAME LIKE '%Cheddar%');
```

- 활용

`Entry.objects.all()[0]`

`SELECT ... LIMIT 1;`

`Entry.objects.order_by('-id')`

`SELECT ... ORDER BY id DESC;`

## ORM 확장(1:N)

```PYTHON
# models.Model 내부 클래스를 상속받음
class Genre(models.Model):
    name = models.CharField(max_length = 30)

class Artist(models.Model):
    name = models.CharField(max_length = 30)
    debut = models.DateField()

# Genre는 Album을 0 ~ n개 가짐 / Album은 하나의 Genre를 가짐
# Artist는 Album을 0 ~ n개 가짐 / Album은 하나의 Artist를 가짐
class Album(models.Model):
    name = models.CharField(max_length = 30)
    genre = models.ForeignKey('Genre', on_delete = models.CASCADE)
    artist = models.ForeignKey('Artist', on_delete = models.CASCADE)
```

- Foreign Key(외래키)
  - 키를 사용하여 부모 테이블의 유일한 값을 참조(참조 무결성)
    - 데이터베이스 관계 모델에서 관련된 2개의 테이블 간의 일관성
  - 외래 키의 값이 반드시 부모 테이블의 기본 키일 필요는 없지만 유일한 값이어야 함
- models.ForeignKey 필드
  - Model class : 참조하는 모델
  - on_delete : 외래 키가 참조하는 객체가 삭제되었을 때 처리 방식
    - CASCADE : 부모 객체가 삭제됐을 때 이를 참조하는 객체도 삭제
    - PROTECT : 삭제되지 않음
    - SET_NULL : NULL
    - SET_DEFAULT : 기본값

- CREATE

  ```python
  # Genre
  Genre.objects.create(name = '발라드')
  
  # Artist
  artist = Artist()
  artist.name = '아이유'
  artist.debut = '2019-12-25'
  artist.save()
  
  # Album(1:N관계)
  # 객체
  artist = Artist.objects.get(id = 1)
  genre = Genre.objects.get(id = 1)
  album = Album()
  album.name = '앨범1'
  album.artist = artist
  album.genre = genre
  album.save()
  
  # 값
  album = Album()
  album.name = '앨범2'
  album.artist_id = 1
  album.genre_id = 1
  album.save()
  ```

- 참조와 역참조

  ```python
  # 1.참조(N -> 1)
  album = Album.objects.get(id = 1)
  album.artist.name
  album.artist.debut
  album.genre.name
  
  # 2.역참조(1 -> N)
  genre = Genre.objects.get(id = 1)
  genre.album_set.all()
  ```

  



